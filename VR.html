<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Simple WebXR VR Game — Table Interaction</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@3.3.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/super-hands@^4.0.4/dist/aframe-super-hands.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0b}
    .overlay-ui{position:fixed;left:12px;bottom:12px;z-index:9999;display:flex;gap:8px}
    .btn{background:#111;border:2px solid #eee;color:#eee;padding:8px 12px;border-radius:6px;font-family:monospace;cursor:pointer;opacity:0.95}
    .btn:active{transform:translateY(1px)}
    .hint{position:fixed;left:12px;top:12px;color:#ddd;font-family:monospace;background:rgba(0,0,0,0.3);padding:8px;border-radius:6px}
  </style>
</head>
<body>

<div class="hint">Grab, stack, and throw objects on the table. No 2D menus — everything is in-world.</div>
<div class="overlay-ui">
  <button id="enterVR" class="btn">Enter VR</button>
  <button id="enterAR" class="btn">Enter AR</button>
</div>

<a-scene vr-mode-ui="enabled: true" embedded renderer="colorManagement: true;physicallyCorrectLights: true" background="color: #070707">

  <!-- camera + hands -->
  <a-entity id="cameraRig">
    <a-entity camera position="0 1.6 0" look-controls wasd-controls></a-entity>

    <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #888" super-hands
              physics-collider="objects: .dynamic" grabbable droppable stretchable></a-entity>

    <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color:#aaa" super-hands
              physics-collider="objects: .dynamic" grabbable droppable stretchable></a-entity>
  </a-entity>

  <!-- lighting -->
  <a-entity light="type: ambient; intensity: 0.6"></a-entity>
  <a-entity light="type: directional; intensity: 0.9" position="-1 3 1"></a-entity>

  <!-- floor -->
  <a-plane rotation="-90 0 0" width="50" height="50" color="#111" static-body></a-plane>

  <!-- table placed in front of player -->
  <a-entity id="tableGroup" position="0 0 -1.2">
    <!-- table top -->
    <a-box id="tableTop" position="0 0.6 0" width="1.6" depth="1" height="0.08" color="#6b4f3f" static-body></a-box>
    <!-- table legs -->
    <a-box position="-0.7 0.3 -0.45" width="0.08" depth="0.08" height="0.6" color="#4a3426" static-body></a-box>
    <a-box position="0.7 0.3 -0.45" width="0.08" depth="0.08" height="0.6" color="#4a3426" static-body></a-box>
    <a-box position="-0.7 0.3 0.45" width="0.08" depth="0.08" height="0.6" color="#4a3426" static-body></a-box>
    <a-box position="0.7 0.3 0.45" width="0.08" depth="0.08" height="0.6" color="#4a3426" static-body></a-box>

    <!-- interactive objects on table (dynamic) -->
    <!-- plate -->
    <a-cylinder class="dynamic" id="plate" position="-0.5 0.72 0" radius="0.18" height="0.03" color="#ffffff" dynamic-body grabbable></a-cylinder>
    <!-- cup -->
    <a-cylinder class="dynamic" id="cup" position="-0.15 0.78 0" radius="0.08" height="0.14" color="#cddc39" dynamic-body grabbable></a-cylinder>
    <!-- bottle -->
    <a-cylinder class="dynamic" id="bottle" position="0.25 0.8 -0.1" radius="0.05" height="0.3" color="#2196f3" dynamic-body grabbable></a-cylinder>
    <!-- fork (thin box) -->
    <a-box class="dynamic" id="fork" position="0.65 0.72 0" width="0.02" depth="0.06" height="0.18" color="#9e9e9e" dynamic-body grabbable></a-box>
    <!-- ball -->
    <a-sphere class="dynamic" id="ball" position="0 0.9 0.25" radius="0.07" color="#ff5722" dynamic-body grabbable></a-sphere>
    <!-- stack of small boxes for pushing/piling -->
    <a-box class="dynamic" position="0.4 0.72 0.35" width="0.12" height="0.12" depth="0.12" color="#8bc34a" dynamic-body grabbable></a-box>
    <a-box class="dynamic" position="0.55 0.84 0.35" width="0.12" height="0.12" depth="0.12" color="#ffeb3b" dynamic-body grabbable></a-box>
  </a-entity>

  <!-- simple in-world HUD -->
  <a-entity id="hud" position="0 2 -1.1">
    <a-plane width="0.9" height="0.28" color="#000" opacity="0.55"></a-plane>
    <a-text id="objCount" value="Interactive objects: 7" align="center" position="0 0 0.01" color="#fff"></a-text>
  </a-entity>

  <!-- physics system initialization -->
  <a-entity physics="gravity: -9.8"></a-entity>

</a-scene>

<script>
const scene = document.querySelector('a-scene');
const enterVRBtn = document.getElementById('enterVR');
const enterARBtn = document.getElementById('enterAR');

enterVRBtn.addEventListener('click', async () => {
  const vrButton = document.querySelector('button[a-enter-vr]') || document.querySelector('.a-enter-vr');
  if (vrButton) { vrButton.click(); return; }
  if (navigator.xr && navigator.xr.isSessionSupported) {
    const supported = await navigator.xr.isSessionSupported('immersive-vr');
    if (supported) {
      try { const session = await navigator.xr.requestSession('immersive-vr'); scene.renderer.xr.setSession(session); }
      catch (err) { alert('Unable to enter VR: ' + err.message); }
    } else alert('Immersive VR not supported on this device/browser.');
  } else alert('WebXR not available in this browser.');
});

enterARBtn.addEventListener('click', async () => {
  if (!navigator.xr || !navigator.xr.isSessionSupported) return alert('WebXR AR not available.');
  const supported = await navigator.xr.isSessionSupported('immersive-ar').catch(()=>false);
  if (!supported) return alert('Immersive AR not supported on this device/browser.');
  try {
    const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local', 'hit-test'] });
    if (scene.renderer && scene.renderer.xr) scene.renderer.xr.setSession(session);
    alert('AR session started. Implement hit-test placement logic for world placement.');
  } catch (err) { alert('Failed to start AR session: ' + err.message); }
});

// Update interactive object count on HUD
function updateCount() {
  const objs = document.querySelectorAll('.dynamic');
  const text = document.getElementById('objCount');
  if (text) text.setAttribute('value', `Interactive objects: ${objs.length}`);
}
setInterval(updateCount, 800);

// Small UX: when user grabs an object, add a subtle upward impulse when released if thrown fast.
document.body.addEventListener('mouseup', ()=>{}); // placeholder to keep responsiveness

// Optional: reset objects if they fall off the world (y < -5)
setInterval(()=>{
  document.querySelectorAll('.dynamic').forEach(el=>{
    if (!el.object3D) return;
    const y = el.object3D.position.y;
    if (y < -5) {
      // teleport back onto the table with a small random offset
      const table = document.getElementById('tableGroup');
      const tx = (Math.random()-0.5)*0.6;
      const tz = (Math.random()-0.5)*0.4;
      el.setAttribute('position', `${tx} 0.9 ${tz}`);
      // reset velocity if physics system supports it
      if (el.body) {
        el.body.velocity.set(0,0,0);
        el.body.angularVelocity.set(0,0,0);
      }
    }
  });
}, 1500);

</script>

</body>
</html>
