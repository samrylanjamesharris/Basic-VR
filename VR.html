<!DOCTYPE html>
<html>
<head>
    <title>Zero-Gravity Playground</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- A-Frame Physics System (Ammo.js integration) -->
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <!-- A-Frame Super Hands for grab and interaction logic -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-super-hands-component@3.0.0/dist/super-hands.min.js"></script>

    <style>
        /* Optional: Basic styling for a minimal container */
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
    </style>

    <script>
        // Custom Zero-G Propulsion Component
        AFRAME.registerComponent('zero-g-pusher', {
            schema: {
                pushForce: {type: 'number', default: 5} // Multiplier for propulsion speed
            },
            init: function () {
                // Find the main player rig entity
                this.rig = document.getElementById('rig');
                
                // State variables
                this.grabbedStatic = false;
                this.startPos = new THREE.Vector3();

                // Listen for Super Hands events
                this.el.addEventListener('grab-start', this.onGrabStart.bind(this));
                this.el.addEventListener('grab-end', this.onGrabEnd.bind(this));
            },

            onGrabStart: function (evt) {
                // Check if the grabbed object has a static physics body (i.e., walls/rails)
                const grabbedEl = evt.detail.target;
                const physicsBody = grabbedEl.components['ammo-body'];

                if (physicsBody && physicsBody.data.type === 'static') {
                    this.grabbedStatic = true;
                    // Record the hand's world position at the start of the grab
                    this.el.object3D.getWorldPosition(this.startPos);
                } else {
                    this.grabbedStatic = false;
                }
            },

            onGrabEnd: function () {
                // Only process the release if we were holding a static object
                if (this.grabbedStatic && this.rig.components['ammo-body'] && this.rig.components['ammo-body'].body) {
                    const endPos = new THREE.Vector3();
                    this.el.object3D.getWorldPosition(endPos);
                    
                    // 1. Calculate the vector of the push (hand displacement)
                    const pushVector = new THREE.Vector3().subVectors(endPos, this.startPos);
                    
                    // 2. Only propel if the push was significant
                    if (pushVector.length() > 0.03) { // Minimum movement threshold
                        
                        // 3. Propulsion is the opposite of the push direction
                        const propulsionVector = pushVector.normalize().multiplyScalar(-this.data.pushForce);

                        // 4. Get the player rig's physics body
                        const body = this.rig.components['ammo-body'].body;
                        
                        // 5. Get current velocity and add the propulsion vector (momentum transfer)
                        const ammoVelocity = body.getLinearVelocity();
                        const currentVelocity = new THREE.Vector3(ammoVelocity.x(), ammoVelocity.y(), ammoVelocity.z());

                        const newVelocity = currentVelocity.add(propulsionVector);
                        
                        // 6. Set the new velocity on the rig
                        body.setLinearVelocity(new Ammo.btVector3(newVelocity.x, newVelocity.y, newVelocity.z));
                    }
                }
                this.grabbedStatic = false;
            }
        });
        
        // Ensure A-Frame is ready before doing setup
        window.onload = function() {
            // Log that components are ready
            console.log("A-Frame Zero-G Playground ready.");
        };
    </script>
</head>
<body>

    <!--
        A-Frame Scene Setup:
        - vr-mode-ui is active by default, providing VR and AR buttons.
        - physics="gravity: 0" creates the zero-gravity environment.
    -->
    <a-scene 
        id="scene"
        cursor="rayOrigin: mouse; fuse: false" 
        raycaster="objects: [raycasterable]"
        physics="gravity: 0; iterations: 10; maxSubSteps: 5;"
        >

        <!-- Environment Setup: Dark, space-like background -->
        <a-sky color="#000000"></a-sky>

        <!-- Lighting for visibility -->
        <a-entity light="type: ambient; color: #BBB"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>

        <!-- 
            Player Rig (The root entity that moves) 
            - camera: Standard A-Frame camera
            - ammo-body: Dynamic type with mass allows it to be pushed.
            - ammo-shape: Defines the collision shape (a simple sphere for the player).
        -->
        <a-entity id="rig" position="0 0 0" rotation="0 0 0" 
                  ammo-body="type: dynamic; mass: 500; linearDamping: 0.05; angularDamping: 0.95;"
                  ammo-shape="type: sphere; fit: manual; sphereRadius: 0.5">
            
            <!-- Camera (Head) -->
            <a-camera user-height="0" position="0 0 0" look-controls="enabled: true"></a-camera>

            <!-- 
                Hands (Controllers) 
                - super-hands: Enables grabbing and physics interactions
                - zero-g-pusher: Our custom component for propulsion
            -->
            <!-- Right Hand (Controller) -->
            <a-entity id="rightHand" 
                      laser-controls="hand: right" 
                      super-hands="colliderEvent: raycaster-intersection; colliderEventProperty: els; colliderEndEvent: raycaster-intersection-cleared;"
                      zero-g-pusher="pushForce: 5">
                <a-sphere color="#FFFFFF" radius="0.03" opacity="0.8"></a-sphere>
            </a-entity>

            <!-- Left Hand (Controller) -->
            <a-entity id="leftHand" 
                      laser-controls="hand: left" 
                      super-hands="colliderEvent: raycaster-intersection; colliderEventProperty: els; colliderEndEvent: raycaster-intersection-cleared;"
                      zero-g-pusher="pushForce: 5">
                <a-sphere color="#FFFFFF" radius="0.03" opacity="0.8"></a-sphere>
            </a-entity>
        </a-entity>

        <!-- Zero-G Environment (Walls, Floor, Rails) -->
        <!-- All environment geometry is static and grabbable -->

        <!-- Floor (Static Anchor) -->
        <a-box position="0 -10 0" rotation="-90 0 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>

        <!-- Walls (Static Anchors) -->
        <a-box position="0 10 0" rotation="0 0 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>
        <a-box position="20 0 0" rotation="0 90 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>
        <a-box position="-20 0 0" rotation="0 90 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>
        <a-box position="0 0 -20" rotation="0 0 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>
        <a-box position="0 0 20" rotation="0 0 0" width="40" height="40" depth="0.1" 
               color="#333333" roughness="0.8" 
               ammo-body="type: static" ammo-shape="type: box"></a-box>

        <!-- Rails (Static Grabbable Objects) -->
        <a-entity id="rail-1" position="10 0 -5" rotation="0 90 0"
                  ammo-body="type: static" ammo-shape="type: box">
            <a-box width="10" height="0.1" depth="0.1" color="#8888AA" raycasterable></a-box>
        </a-entity>
        <a-entity id="rail-2" position="-10 5 0" rotation="90 0 0"
                  ammo-body="type: static" ammo-shape="type: box">
            <a-box width="10" height="0.1" depth="0.1" color="#8888AA" raycasterable></a-box>
        </a-entity>
        <a-entity id="rail-3" position="0 -5 10" rotation="0 0 0"
                  ammo-body="type: static" ammo-shape="type: box">
            <a-box width="10" height="0.1" depth="0.1" color="#8888AA" raycasterable></a-box>
        </a-entity>

        <!-- Throwable Objects (Dynamic) -->
        <!-- Pushing these away will also propel the player slightly, due to physics mass transfer. -->
        <a-entity position="0 0 -5"
                  ammo-body="type: dynamic; mass: 20; linearDamping: 0.1; angularDamping: 0.9;"
                  ammo-shape="type: sphere; sphereRadius: 0.5">
            <a-sphere color="#FF5733" radius="0.5" raycasterable></a-sphere>
        </a-entity>

        <a-entity position="-2 3 0"
                  ammo-body="type: dynamic; mass: 5; linearDamping: 0.1; angularDamping: 0.9;"
                  ammo-shape="type: box; halfExtents: 0.5 0.5 0.5">
            <a-box color="#33FF57" width="1" height="1" depth="1" raycasterable></a-box>
        </a-entity>

        <a-entity position="5 -1 -5"
                  ammo-body="type: dynamic; mass: 10; linearDamping: 0.1; angularDamping: 0.9;"
                  ammo-shape="type: sphere; sphereRadius: 0.7">
            <a-sphere color="#3357FF" radius="0.7" raycasterable></a-sphere>
        </a-entity>
        
        <!-- Instruction Text (3D Menu Replacement) -->
        <a-entity position="0 0 -3" text="value: Zero-Gravity Playground; align: center; color: #FFFFFF; width: 3; font: ^https://cdn.aframe.io/fonts/Aileron-Bold.fnt"></a-entity>
        <a-entity position="0 -0.5 -3" text="value: Grab a rail or wall and push off to move.; align: center; color: #AAAAAA; width: 2;"></a-entity>
        <a-entity position="0 -1 -3" text="value: Grab and throw objects for a smaller boost.; align: center; color: #AAAAAA; width: 2;"></a-entity>

    </a-scene>
</body>
</html>
