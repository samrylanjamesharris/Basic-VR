<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8">
      <!-- Player -->
      <a-entity position="0 1.6 0" movement-controls="fly: true">
        <a-camera></a-camera>
        
        <!-- Hands with visual controllers -->
        <a-entity id="left-hand"
                  hand-controls="left"
                  oculus-touch-controls="hand: left"
                  vive-controls="hand: left"
                  super-hands="colliderEvent: collisions; colliderEventProperty: els"
                  dynamic-body="shape: sphere; sphereRadius: 0.02">
          <a-sphere radius="0.02" color="blue" position="0 0.05 0"></a-sphere>
          <a-box width="0.02" height="0.04" depth="0.02" color="lightblue" position="0 0 0"></a-box>
        </a-entity>

        <a-entity id="right-hand"
                  hand-controls="right"
                  oculus-touch-controls="hand: right"
                  vive-controls="hand: right"
                  super-hands="colliderEvent: collisions; colliderEventProperty: els"
                  dynamic-body="shape: sphere; sphereRadius: 0.02">
          <a-sphere radius="0.02" color="red" position="0 0.05 0"></a-sphere>
          <a-box width="0.02" height="0.04" depth="0.02" color="pink" position="0 0 0"></a-box>
        </a-entity>
      </a-entity>

      <!-- Interactable Objects -->
      <a-box id="box1" 
             position="-1 1 -3" 
             width="0.5" height="0.5" depth="0.5"
             color="#4CC3D9" 
             dynamic-body="shape: box"
             class="interactable"
             event-set__dragstart="_event: grab-start; material.opacity: 0.5"
             event-set__dragend="_event: grab-end; material.opacity: 1">
      </a-box>
      
      <a-sphere id="sphere1" 
                position="0 1.5 -4" 
                radius="0.3" 
                color="#EF2D5E" 
                dynamic-body="shape: sphere"
                class="interactable"
                event-set__dragstart="_event: grab-start; material.opacity: 0.5"
                event-set__dragend="_event: grab-end; material.opacity: 1">
      </a-sphere>
      
      <a-cylinder id="cylinder1" 
                  position="1 1 -3" 
                  radius="0.2" 
                  height="0.6" 
                  color="#FFC65D" 
                  dynamic-body="shape: cylinder"
                  class="interactable"
                  event-set__dragstart="_event: grab-start; material.opacity: 0.5"
                  event-set__dragend="_event: grab-end; material.opacity: 1">
      </a-cylinder>

      <!-- Ground -->
      <a-plane position="0 0 -4" rotation="-90 0 0" width="8" height="8" color="#7BC8A4" static-body></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>
      // Super-hands component for grab interactions
      AFRAME.registerComponent('super-hands', {
        schema: {
          colliderEvent: {default: 'hit'},
          colliderEventProperty: {default: 'target'}
        },
        
        init: function() {
          this.grabbing = false;
          this.targetEls = [];
          this.offset = new THREE.Vector3();
          this.raycaster = new THREE.Raycaster();
          this.tempMatrix = new THREE.Matrix4();
          
          this.el.addEventListener('gripdown', this.onGripDown.bind(this));
          this.el.addEventListener('gripup', this.onGripUp.bind(this));
          this.el.addEventListener(this.data.colliderEvent, this.onCollider.bind(this));
        },
        
        onGripDown: function() {
          this.grabbing = true;
          if (this.targetEls.length > 0) {
            const target = this.targetEls[0];
            this.offset.subVectors(
              this.el.object3D.position,
              target.object3D.position
            );
          }
        },
        
        onGripUp: function() {
          this.grabbing = false;
          this.targetEls = [];
        },
        
        onCollider: function(e) {
          const target = e.detail[this.data.colliderEventProperty];
          if (target && target !== this.el) {
            this.targetEls = [target];
          }
        },
        
        tick: function() {
          if (this.grabbing && this.targetEls.length > 0) {
            const target = this.targetEls[0];
            const worldPos = new THREE.Vector3();
            this.el.object3D.getWorldPosition(worldPos);
            target.object3D.position.copy(worldPos.sub(this.offset));
          }
        }
      });
    </script>
  </body>
</html>
