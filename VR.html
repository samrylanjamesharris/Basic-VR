<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR VR Game with Hand Tracking</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0f1222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            z-index: 10;
        }
        
        .score-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            z-index: 10;
        }
        
        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 10;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div class="score-container">
            Score: <span id="score">0</span>
        </div>
        
        <div class="instructions">
            <p>Use your hands to grab and throw objects at the target to score points!</p>
        </div>
        
        <div id="status">Initializing WebXR...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/VRControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/dist/webxr-polyfill.js"></script>
    
    <script>
        // Initialize Three.js and WebXR
        let scene, camera, renderer, controls;
        let vrButton;
        let score = 0;
        let gameObjects = [];
        let handMeshes = [];
        let target;
        let raycaster;
        let clock = new THREE.Clock();
        
        // Initialize the scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f1222);
            scene.fog = new THREE.Fog(0x0f1222, 10, 20);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 3);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2a3b5c,
                roughness: 0.8,
                metalness: 0.2
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -0.5;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20, 0x444466, 0x222244);
            gridHelper.position.y = -0.49;
            scene.add(gridHelper);
            
            // Create target
            const targetGeometry = new THREE.CylinderGeometry(1.5, 1.5, 0.2, 32);
            const targetMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xff3366,
                emissive: 0x880022,
                roughness: 0.4,
                metalness: 0.6
            });
            target = new THREE.Mesh(targetGeometry, targetMaterial);
            target.position.set(0, 0.5, -5);
            target.rotation.x = Math.PI / 2;
            scene.add(target);
            
            // Add target rings
            for (let i = 0; i < 3; i++) {
                const ringGeometry = new THREE.RingGeometry(1.2 + i*0.5, 1.4 + i*0.5, 32);
                const ringMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xff9966,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.7 - i*0.2
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.position.set(0, 0.51, -5);
                ring.rotation.x = Math.PI / 2;
                scene.add(ring);
            }
            
            // Create some initial game objects
            createGameObject();
            createGameObject();
            createGameObject();
            
            // Setup WebXR
            setupWebXR();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        function createGameObject() {
            const colors = [0xff6b6b, 0x4ecdc4, 0x1a936f, 0xffd166, 0x118ab2];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
            const material = new THREE.MeshStandardMaterial({ 
                color: color,
                roughness: 0.3,
                metalness: 0.7
            });
            
            const cube = new THREE.Mesh(geometry, material);
            
            // Random position
            cube.position.set(
                (Math.random() - 0.5) * 4,
                Math.random() * 2 + 0.5,
                (Math.random() - 0.5) * 4 - 3
            );
            
            cube.castShadow = true;
            cube.receiveShadow = true;
            
            // Add physics properties
            cube.userData = {
                velocity: new THREE.Vector3(),
                isGrabbed: false
            };
            
            scene.add(cube);
            gameObjects.push(cube);
        }
        
        function setupWebXR() {
            // Check for WebXR support
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                    if (supported) {
                        document.getElementById('status').textContent = 'WebXR supported. Entering VR...';
                        
                        // Request a VR session immediately
                        navigator.xr.requestSession('immersive-vr').then((session) => {
                            renderer.xr.setSession(session);
                            document.getElementById('status').textContent = 'VR session started. Use your hands to interact!';
                        }).catch(err => {
                            document.getElementById('status').textContent = 'Failed to start VR session: ' + err.message;
                        });
                        
                        // Add event listener for session start
                        renderer.xr.addEventListener('sessionstart', () => {
                            document.getElementById('status').textContent = 'VR session started. Use your hands to interact!';
                        });
                        
                        renderer.xr.addEventListener('sessionend', () => {
                            document.getElementById('status').textContent = 'VR session ended.';
                        });
                    } else {
                        document.getElementById('status').textContent = 'WebXR not supported in this browser.';
                    }
                });
            } else {
                document.getElementById('status').textContent = 'WebXR not supported in this browser.';
            }
            
            // Setup controllers (for hand tracking)
            const controllerModelFactory = new THREE.GLTFLoader();
            
            function onControllerConnected(controller) {
                controller.addEventListener('connected', function (event) {
                    if (event.data.targetRayMode === 'tracked-pointer' && event.data.hand) {
                        // This is a hand tracking controller
                        const handMesh = new THREE.Mesh(
                            new THREE.BufferGeometry(),
                            new THREE.MeshBasicMaterial({
                                color: 0x00aaff,
                                wireframe: true,
                                transparent: true,
                                opacity: 0.5
                            })
                        );
                        
                        handMesh.visible = true;
                        scene.add(handMesh);
                        handMeshes.push({ controller, mesh: handMesh });
                        
                        // Add event listener for grabbing
                        controller.addEventListener('selectstart', function () {
                            // Find the closest object to grab
                            const controllerPosition = controller.position;
                            let closestObject = null;
                            let closestDistance = Infinity;
                            
                            for (const obj of gameObjects) {
                                if (obj.userData.isGrabbed) continue;
                                
                                const distance = controllerPosition.distanceTo(obj.position);
                                if (distance < closestDistance && distance < 0.5) {
                                    closestDistance = distance;
                                    closestObject = obj;
                                }
                            }
                            
                            if (closestO
